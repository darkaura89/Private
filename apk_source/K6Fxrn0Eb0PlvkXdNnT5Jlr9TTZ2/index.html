<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>DARK CYBER — ADMIN PANEL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <style>
        /* --- NEW PREMIUM STYLE SHEET --- */
        :root{
            --primary: #00c6ff;
            --accent: #0072ff;
            --bg-dark: #0d1117;  /* GitHub Dark */
            --bg-light: #161b22; /* GitHub Dark Lighter */
            --border-color: rgba(255, 255, 255, 0.1);
            --text: #e6edf3;
            --text-secondary: #a3b3c3;
            --success: #2ee56a;
            --warning: #f6d365;
            --danger: #ff4d4d;
        }
        *{
            box-sizing:border-box;
            margin:0;
            padding:0;
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body{
            background:var(--bg-dark);
            color:var(--text);
            padding:20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Particles Container */
        #particles-js{
            position:fixed;left:0;top:0;width:100%;height:100%;z-index:0;
            background:linear-gradient(180deg, var(--bg-dark) 0%, #11151c 100%);
        }
        .container{
            width:100%;
            max-width:900px;
            position:relative; 
            z-index:2; 
        }
        
        /* --- NEW NAVBAR --- */
        .navbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--bg-light);
            border-radius: 16px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .menu-icon {
            font-size: 1.2rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .menu-icon:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .nav-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .logout-btn{
            background: #444;
            color: var(--text-secondary);
            width:auto; 
            padding: 10px 15px;
            margin: 0;
            font-size: 14px;
            font-weight: 700;
            border-radius: 10px;
            z-index:3;
            transition: background 0.2s;
        } 
        .logout-btn:hover{
            background: var(--danger);
            color: var(--text);
            transform: none; /* Override btn hover */
            box-shadow: none; /* Override btn hover */
        }
        /* --- END NAVBAR --- */

        h1{ /* Old H1 - removed from view */
            display: none;
        }
        .card{
            background: var(--bg-light);
            border-radius:16px;
            padding: 25px 30px;
            margin-bottom:25px;
            box-shadow:0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            position:relative; 
            z-index:2; 
        }
        .card h2{
            color:var(--primary);
            margin-bottom:20px;
            border-bottom:1px solid var(--border-color);
            padding-bottom:15px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        .form-group{
            margin-bottom: 20px;
        }
        .form-group label{
            display:block;
            margin-bottom:8px;
            font-weight:500;
            color: var(--text-secondary);
        }
        .form-group input, .form-group select{
            width:100%;
            padding: 14px;
            border-radius:10px;
            border: 1px solid var(--border-color);
            background: rgba(0,0,0,0.3);
            color:var(--text);
            font-size:16px;
            font-weight: 500;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 198, 255, 0.3);
        }
        .time-inputs {
            display: flex;
            gap: 15px;
        }
        .time-inputs > div {
            flex: 1; 
            min-width: 0;
        }
        .time-inputs label {
            font-size: 12px;
            margin-top: 5px;
            text-align: center;
            color: var(--text-secondary);
        }
        .time-inputs input[type="number"] {
            text-align: center;
            padding: 12px 8px; 
            font-weight: 700;
        }

        .btn{
            padding:14px 20px;
            border:none;
            border-radius:10px;
            font-weight:700;
            cursor:pointer;
            transition: all 0.3s ease;
            width:100%;
            font-size:16px;
            margin-top:10px;
            letter-spacing: 0.5px;
        }
        .btn-primary{
            background: linear-gradient(90deg, var(--accent), var(--primary));
            color:var(--bg-dark);
            box-shadow: 0 5px 15px rgba(0, 114, 255, 0.3);
        }
        .btn-primary:hover{
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 198, 255, 0.4);
        }
        
        /* --- MODIFIED KEY LIST SCROLL --- */
        .table-wrapper {
            max-height: 400px; /* Max height for the table area */
            overflow-y: auto; /* Add vertical scrollbar when needed */
            padding-right: 5px; /* Space for scrollbar */
        }
        
        /* Custom Scrollbar */
        .table-wrapper::-webkit-scrollbar {
            width: 8px;
        }
        .table-wrapper::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        .table-wrapper::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: 10px;
            border: 2px solid var(--bg-light);
        }
        
        #keyHistory {
            width:100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
        }
        #keyHistory th, #keyHistory td {
            padding: 16px 12px;
            text-align:left;
            border-bottom:1px solid var(--border-color);
            font-size:14px;
            vertical-align: middle;
        }
        #keyHistory th {
            background: var(--bg-light); /* Make header sticky */
            position: sticky;
            top: 0;
            z-index: 1;
            color:var(--primary);
            font-weight: 700;
            letter-spacing: 0.5px;
            border-bottom-width: 2px;
        }
        #keyHistory tr:last-child td {
            border-bottom: none;
        }
        #keyHistory tr:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }
        #keyHistory td b {
            color: var(--text);
            font-size: 15px;
            font-weight: 500;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 8px;
            font-weight:700;
            font-size:12px;
            text-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        .status-active{background:var(--success);color:#000;}
        .status-expired{background:var(--danger);color:var(--text);}
        .status-deactivated{background:var(--warning);color:#000;}

        .action-btn{
            padding: 8px 12px;
            border-radius: 8px;
            margin: 2px;
            font-size: 12px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-delete{background:var(--danger);color:var(--text);}
        .action-deactivate{background:var(--warning);color:#000;}
        .action-delete:hover{background:#c0392b;}
        .action-deactivate:hover{background:#f1c40f;}
        .action-btn:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
        }

        /* Login Modal */
        #loginModal{
            position:fixed;left:0;top:0;width:100%;height:100%;
            display:flex;justify-content:center;align-items:center;z-index:10; 
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
        }
        .login-box{
            width:90%;
            max-width:380px;
            background:var(--bg-light);
            padding: 35px 30px;
            border-radius:16px;
            text-align:center;
            box-shadow:0 0 30px rgba(0,0,0,0.7);
            border: 1px solid var(--border-color);
            position:relative; 
            z-index:2; 
        }
        .login-box h2{
            color:var(--primary);
            margin-bottom:25px;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        @media (max-width: 600px) {
            body { padding: 10px; }
            .navbar {
                padding: 10px 15px;
                margin-bottom: 20px;
            }
            .nav-title { font-size: 1.2rem; }
            .card { padding: 20px 15px; }
            .time-inputs { flex-direction: column; gap: 10px; }
            .action-btn { width: calc(100% - 4px); }
        }
    </style>
</head>
<body onload="checkAdminLogin()">

    <div id="particles-js"></div> 

    <div id="loginModal">
        <div class="login-box">
            <h2><i class="fas fa-user-shield"></i> Admin Login</h2>
            <div class="form-group">
                <input type="text" id="usernameInput" placeholder="Username" />
            </div>
            <div class="form-group">
                <input type="password" id="passwordInput" placeholder="Password" />
            </div>
            <button class="btn btn-primary" id="loginBtn">Login</button>
        </div>
    </div>

    <div class="container" id="adminContent" style="display:none;">
        
        <div class="navbar">
            <div class="nav-left">
                <i class="fas fa-bars menu-icon"></i>
                <span class="nav-title">Admin Dashboard</span>
            </div>
            <button class="btn logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
        
        <h1>DARK CYBER - ADMIN PANEL</h1> <div class="card">
            <h2><i class="fas fa-key"></i> Generate New VIP Key</h2>
            <div id="statusMessage" style="color:var(--success); margin-bottom:15px; font-weight: 500;"></div>
            
            <div class="form-group">
                <label>Key Duration:</label>
                <div class="time-inputs">
                    <div>
                        <input type="number" id="durationDays" min="0" value="0" placeholder="0" />
                        <label>Days</label>
                    </div>
                    <div>
                        <input type="number" id="durationHours" min="0" max="24" value="24" placeholder="24" />
                        <label>Hours</label>
                    </div>
                    <div>
                        <input type="number" id="durationMinutes" min="0" max="60" value="0" placeholder="0" />
                        <label>Minutes</label>
                    </div>
                    <div>
                        <input type="number" id="durationSeconds" min="0" max="60" value="0" placeholder="0" />
                        <label>Seconds</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="deviceLimit">Device Limit:</label>
                <select id="deviceLimit">
                    <option value="unlimited" selected>Unlimited Devices</option>
                    <option value="1">1 Device</option>
                    <option value="2">2 Devices</option>
                    <option value="3">3 Devices</option>
                    <option value="5">5 Devices</option>
                    <option value="10">10 Devices</option>
                </select>
            </div>
            <button class="btn btn-primary" id="generateKeyBtn"><i class="fas fa-magic"></i> GENERATE KEY</button>
        </div>

        <div class="card">
            <h2><i class="fas fa-history"></i> VIP Key History</h2>
            <div class="table-wrapper" id="tableWrapper">
                <table id="keyHistory">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Status</th>
                            <th>Devices</th>
                            <th>Expires</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // Particle Initialization (Matching Index.html's Premium Look)
        particlesJS("particles-js", {
            "particles": {
                "number": {"value": 70, "density": {"enable": true, "value_area": 800}},
                "color": {"value": ["#00c6ff", "#0072ff", "#f6d365", "#ffffff"]}, 
                "shape": {"type": "circle"},
                "opacity": {"value": 0.5, "anim": {"enable": false}},
                "size": {"value": 3, "random": true},
                "line_linked": {"enable": true, "distance": 150, "color": "#0072ff", "opacity": 0.35, "width": 1},
                "move": {"enable": true, "speed": 1.5, "direction": "none", "random": false, "straight": false, "out_mode": "out"}
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {"onhover": {"enable": true, "mode": "grab"}, "onclick": {"enable": true, "mode": "push"}},
                "modes": {"grab": {"distance": 140, "line_linked": {"opacity": 1}}, "push": {"particles_nb": 4}}
            },
            "retina_detect": true
        });

        // --- ADMIN CONFIGURATION ---
        const ADMIN_USERNAME = "DARK"; 
        const ADMIN_PASSWORD = "123"; 

        // *************************************************************
        // YAHA PE APNA FIREBASE CONFIGURATION PAIST KARE
        const firebaseConfig = {
          apiKey: "AIzaSyA7sfTGPn7iiCrXbK5ESNVVcZr2RJmJ7YU",
          authDomain: "dark-cyber-63a93.firebaseapp.com",
          // --- YEH RAHI SAHI WALI LINE ---
          databaseURL: "https://dark-cyber-63a93-default-rtdb.firebaseio.com",
          projectId: "dark-cyber-63a93",
          storageBucket: "dark-cyber-63a93.firebasestorage.app",
          messagingSenderId: "137994980735",
          appId: "1:137994980735:web:7d933e66b201e98ca95e4a",
          measurementId: "G-FRN1VD2ESV"
        };
        // FIREBASE CONFIGURATION END
        // *************************************************************

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const vipCodesRef = database.ref('vip_codes');
        
        // --- AUTHENTICATION LOGIC ---
        function checkAdminLogin() {
            if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                loadKeyHistory();
            } else {
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('adminContent').style.display = 'none';
            }
        }

        document.getElementById('loginBtn').addEventListener('click', () => {
            const user = document.getElementById('usernameInput').value;
            const pass = document.getElementById('passwordInput').value;

            if (user === ADMIN_USERNAME && pass === ADMIN_PASSWORD) {
                sessionStorage.setItem('isAdminLoggedIn', 'true');
                checkAdminLogin();
            } else {
                alert('Invalid Credentials!');
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            sessionStorage.removeItem('isAdminLoggedIn');
            checkAdminLogin();
        });
        
        // --- KEY MANAGEMENT LOGIC ---
        
        function generateRandomString(length) {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function formatDurationSuffix(days, hours, minutes, seconds) {
            if (days > 0) return `${days}day`;
            if (hours > 0) return `${hours}hr`;
            if (minutes > 0) return `${minutes}min`;
            if (seconds > 0) return `${seconds}sec`;
            return 'key'; // Fallback
        }

        document.getElementById('generateKeyBtn').addEventListener('click', () => {
            const days = parseInt(document.getElementById('durationDays').value) || 0;
            const hours = parseInt(document.getElementById('durationHours').value) || 0;
            const minutes = parseInt(document.getElementById('durationMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('durationSeconds').value) || 0;
            
            const deviceLimitInput = document.getElementById('deviceLimit').value;
            let deviceLimit = (deviceLimitInput === 'unlimited') ? 'unlimited' : parseInt(deviceLimitInput);
            
            const totalDurationMs = (days*86400 + hours*3600 + minutes*60 + seconds) * 1000;

            if (totalDurationMs <= 0) {
                 document.getElementById('statusMessage').innerHTML = `<span style="color:var(--danger);">❌ Duration must be greater than zero!</span>`;
                 return;
            }
            
            const randomPart = generateRandomString(10);
            const durationSuffix = formatDurationSuffix(days, hours, minutes, seconds);
            const newCode = randomPart + durationSuffix;

            const now = Date.now();
            const expiryTimestamp = now + totalDurationMs; 

            const keyData = {
                createdAt: now,
                expiryTimestamp: expiryTimestamp,
                durationMs: totalDurationMs, 
                deviceLimit: deviceLimit,
                activeCount: 0,
                isManuallyExpired: false, 
                activatedDevices: {}
            };

            vipCodesRef.child(newCode).set(keyData)
                .then(() => {
                    document.getElementById('statusMessage').innerHTML = `<span style="color:var(--success);">✅ Key Generated! Code: <b>${newCode}</b></span>`;
                    loadKeyHistory(); // Reload
                })
                .catch(error => {
                    document.getElementById('statusMessage').innerHTML = `<span style="color:var(--danger);">❌ Error: ${error.message}</span>`;
                });
        });

        // --- KEY HISTORY AND ACTIONS ---
        let keyHistoryListener = null;

        function loadKeyHistory() {
            const tableBody = document.querySelector('#keyHistory tbody');
            
            // Remove old listener if exists
            if (keyHistoryListener) {
                vipCodesRef.off('value', keyHistoryListener);
            }

            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Loading keys...</td></tr>';

            // Set new listener
            keyHistoryListener = vipCodesRef.orderByChild('createdAt').on('value', (snapshot) => {
                tableBody.innerHTML = ''; // Clear table
                const keys = snapshot.val();
                const now = Date.now();
                
                if (!keys) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No VIP keys found.</td></tr>';
                    return;
                }

                const sortedKeys = Object.entries(keys).sort(([, a], [, b]) => b.createdAt - a.createdAt);
                
                sortedKeys.forEach(([code, data]) => {
                    appendKeyRow(tableBody, code, data, now);
                });

            });
        }
        
        function appendKeyRow(tableBody, code, data, now) {
            const isExpired = now > data.expiryTimestamp;
            let statusClass = 'status-active';
            let statusText = 'ACTIVE';

            if (data.isManuallyExpired) {
                statusClass = 'status-deactivated';
                statusText = 'DEACTIVATED';
            } else if (isExpired) {
                statusClass = 'status-expired';
                statusText = 'EXPIRED';
            }
            
            const expiryDate = new Date(data.expiryTimestamp).toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'short'});
            const activeCount = data.activeCount || 0;
            const deviceCounterText = data.deviceLimit === 'unlimited' ? `${activeCount} / ∞` : `${activeCount} / ${data.deviceLimit}`;
            
            const row = tableBody.insertRow(); // Append at the end (for sorting)
            row.innerHTML = `
                <td><b>${code}</b></td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>${deviceCounterText}</td>
                <td>${expiryDate}</td>
                <td>
                    <button class="action-btn action-deactivate" data-code="${code}" data-action="deactivate" ${data.isManuallyExpired || isExpired ? 'disabled' : ''}>
                        Deactivate
                    </button>
                    <button class="action-btn action-delete" data-code="${code}" data-action="delete">
                        Delete
                    </button>
                </td>
            `;
            
             row.querySelectorAll('.action-btn').forEach(button => {
                button.addEventListener('click', handleKeyAction);
            });
        }


        function handleKeyAction(event) {
            const button = event.target;
            const code = button.getAttribute('data-code');
            const action = button.getAttribute('data-action');

            if (action === 'delete') {
                if (confirm(`Are you sure you want to permanently DELETE key ${code}?`)) {
                    vipCodesRef.child(code).remove()
                        .then(() => {
                            alert(`Key ${code} deleted successfully.`);
                            // List will update automatically due to 'on' listener
                        })
                        .catch(error => {
                            alert(`Error deleting key: ${error.message}`);
                        });
                }
            } else if (action === 'deactivate') {
                if (confirm(`Are you sure you want to MANUALLY DEACTIVATE key ${code}? This will stop all current users.`)) {
                    vipCodesRef.child(code).update({ isManuallyExpired: true })
                        .then(() => {
                            alert(`Key ${code} deactivated successfully.`);
                            // List will update automatically
                        })
                        .catch(error => {
                            alert(`Error deactivating key: ${error.message}`);
                        });
                }
            }
        }

    </script>
</body>
</html>